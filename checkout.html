<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
    <title>Checkout | Headphones</title>
    <style>
        .checkout__container {
            max-width: 800px;
            margin: 10rem auto;
            padding: 2rem;
        }

        .checkout__form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .form__group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .form__group input {
            padding: 1rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            outline: none;
        }

        .checkout__summary {
            background-color: var(--extra-light);
            padding: 2rem;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <nav>
        <div class="nav__header">
            <div class="nav__logo">
                <a href="index.html">
                    <img src="assets/logo-dark.png" alt="logo" class="logo-dark" />
                    <img src="assets/logo-white.png" alt="logo" class="logo-white" />
                </a>
            </div>
        </div>
    </nav>

    <section class="checkout__container">
        <h2>Checkout</h2>
        <div class="checkout__form">
            <form id="checkoutForm">
                <h3>Shipping Address</h3>
                <div class="form__group">
                    <label>Address</label>
                    <input type="text" id="address" required />
                </div>
                <div class="form__group">
                    <label>City</label>
                    <input type="text" id="city" required />
                </div>
                <div class="form__group">
                    <label>Postal Code</label>
                    <input type="text" id="postalCode" required />
                </div>
                <div class="form__group">
                    <label>Country</label>
                    <input type="text" id="country" required />
                </div>

                <h3>Payment Details (Mock)</h3>
                <div class="form__group">
                    <label>Card Number</label>
                    <input type="text" placeholder="**** **** **** ****" />
                </div>

                <button type="submit" class="btn" style="width: 100%; margin-top: 1rem;">Place Order</button>
            </form>

            <div class="checkout__summary">
                <h3>Order Summary</h3>
                <div id="orderItems"></div>
                <h4 id="orderTotal" style="margin-top: 1rem;">Total: ₹0</h4>
            </div>
        </div>
    </section>

    <script src="main.js"></script>
    <script>
        console.log('Checkout Page Loaded - Version 1.0.1');
        let cartItemsData = [];
        let totalAmount = 0;

        async function loadCheckout() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch('/api/cart', {
                    headers: { 'Authorization': token }
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to load cart');
                }

                const cart = await response.json();

                const validItems = cart.filter(item => item.productId);
                cartItemsData = validItems;

                const orderItems = document.getElementById('orderItems');

                const total = validItems.reduce((sum, item) => sum + (Number(item.productId.price) * Number(item.quantity)), 0);

                orderItems.innerHTML = validItems.map(item => {
                    const itemTotal = Number(item.productId.price) * Number(item.quantity);
                    return `
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <span>${item.productId.name} x ${item.quantity}</span>
              <span>₹${itemTotal.toFixed(2)}</span>
            </div>
          `;
                }).join('');

                totalAmount = total;
                document.getElementById('orderTotal').innerText = `Total: ₹${total.toFixed(2)}`;
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading checkout: ' + error.message);
            }
        }

        document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const address = document.getElementById('address').value;
            const city = document.getElementById('city').value;
            const postalCode = document.getElementById('postalCode').value;
            const country = document.getElementById('country').value;

            const items = cartItemsData.map(item => ({
                product: item.productId._id,
                quantity: item.quantity,
                price: item.productId.price
            }));

            try {
                const response = await fetch('/api/payment/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({
                        items,
                        totalAmount,
                        shippingAddress: { address, city, postalCode, country }
                    })
                });

                if (response.ok) {
                    alert('Order Placed Successfully!');
                    window.location.href = 'index.html';
                } else {
                    const data = await response.json();
                    alert('Payment Failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error processing payment: ' + error.message);
            }
        });

        loadCheckout();
    </script>
</body>

</html>